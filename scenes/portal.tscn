[gd_scene load_steps=7 format=2]

[ext_resource path="res://collider.tres" type="Shape2D" id=1]
[ext_resource path="res://font.tres" type="DynamicFont" id=2]
[ext_resource path="res://ghost.wav" type="AudioStream" id=3]
[ext_resource path="res://sprites/portal.png" type="Texture" id=4]

[sub_resource type="GDScript" id=5]
script/source = "extends StaticBody2D

export(String, MULTILINE) var dialogue
onready var lines = dialogue.split(\"\\n\")
var skip : bool = false
var talking : bool
var in_conversation : bool

onready var dir = $sprite.flip_h

signal next_line

signal swap_world
var switch_time : bool

func _ready():
	add_to_group(\"portal\")
	$text.visible = false

func _process(delta):
	if not in_conversation:
		return

	if not talking and Input.is_action_pressed(\"talk\"):
		emit_signal(\"next_line\")
	if talking and Input.is_action_just_pressed(\"skip\"):
		skip = true

func interact(player : Node2D):
	if not switch_time:
		talk(player, lines)
		switch_time = true
	else:
		switch_time = false
		emit_signal(\"swap_world\", player.WORLD_NAME, player.position, player.get_node(\"sprite\").flip_h)

func talk(player : Node2D, text : PoolStringArray):
	player.busy = true
	
	in_conversation = true
	skip = false
	if player.position.x < position.x:
		$sprite.flip_h = true
	for line in lines:
		$text.text = \"\"
		talking = true
		for letter in line:
			$talk_sound.pitch_scale = rand_range(0.4, 1.2)
			$talk_sound.play()
			if skip:
				$text.text = line
				skip = false
				break
			$text.text += letter
			if letter != \" \":
				$text_timer.start()
				yield($text_timer, \"timeout\")
		talking = false
		yield(self, \"next_line\")

	$text.text = \"[Z]\"
	$sprite.flip_h = dir
	player.busy = false
	in_conversation = false"

[sub_resource type="AudioStreamRandomPitch" id=6]
audio_stream = ExtResource( 3 )
random_pitch = 1.0

[node name="portal" type="StaticBody2D"]
position = Vector2( 92, 68 )
script = SubResource( 5 )
dialogue = "im the portal
talk to me again
if u wanna be human
:)"

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
shape = ExtResource( 1 )

[node name="text" type="Label" parent="."]
anchor_bottom = 1.0
margin_left = -41.791
margin_top = -13.7524
margin_right = 126.209
margin_bottom = 10.2476
rect_scale = Vector2( 0.5, 0.5 )
custom_fonts/font = ExtResource( 2 )
text = "[Z]"
align = 1
valign = 1

[node name="text_timer" type="Timer" parent="."]
wait_time = 0.1

[node name="talk_sound" type="AudioStreamPlayer2D" parent="."]
stream = SubResource( 6 )
volume_db = -5.361
bus = "Ghost Talk"

[node name="sprite" type="Sprite" parent="."]
texture = ExtResource( 4 )
